name: Deploy to Google VM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Navigate to the project directory
            # We try both underscore and dash versions just in case
            cd spy_helmet_root || cd spy-helmet-root || { echo "Directory not found"; exit 1; }
            
            echo "--------- PULLING LATEST CODE ---------"
            git reset --hard
            git pull origin main
            
            echo "--------- REBUILDING SERVICES ---------"
            chmod +x setup_ssl.sh
            
            # Detect docker compose version
            if command -v docker-compose &> /dev/null; then
                COMPOSE="docker-compose"
            else
                COMPOSE="docker compose"
            fi
            
            # Restart services
            sudo $COMPOSE -f docker-compose.prod.yaml down
            sudo $COMPOSE -f docker-compose.prod.yaml up -d --build
            
            echo "--------- CLEANING UP ---------"
            # Clean up unused images to save disk space
            sudo docker system prune -f
